<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Interface</title>
        <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Ccircle cx='8' cy='8' r='8' fill='%233b82f6'/%3E%3Cpath d='M4 8l2.2 2.2L12 4.4' stroke='%23fff' stroke-width='2' fill='none'/%3E%3C/svg%3E" />
        <!-- Syntax highlighting & Markdown -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            border-radius: 18px 18px 4px 18px;
        }
        .chat-bubble-ai {
            background-color: #f3f4f6;
            color: #111827;
            border-radius: 18px 18px 18px 4px;
        }
        .typing-indicator {
            display: inline-flex;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        .language-switcher.active {
            background-color: #3b82f6;
            color: white;
        }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Фикс-шейка: чистым CSS внутри скролл-контейнера таблицы */
        #articlesTable thead th {
            position: sticky;
            top: 0;
            background: #f9fafb;
            z-index: 1;
        }
        /* Code block styling and copy button */
        pre {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            overflow: auto;
        }
        .code-block-wrapper {
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #374151;
            color: #fff;
            border: none;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.85;
        }
        .copy-button:hover { opacity: 1; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-md" data-aos="zoom-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Sign In</h2>
                <button onclick="toggleLanguage()" class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-300">
                    <span id="languageLabel">EN</span>
                    <i data-feather="globe"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <button onclick="ssoLogin()" class="w-full flex items-center justify-center gap-3 bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition">
                    <i data-feather="key"></i>
                    <span id="ssoText">Sign in with Corporate SSO</span>
                </button>
                
                <div class="relative flex items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-500" id="orText">OR</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1" id="emailLabel">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1" id="passwordLabel">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button onclick="emailLogin()" class="w-full bg-gray-800 hover:bg-gray-900 text-white py-3 px-4 rounded-lg transition">
                        <span id="signInText">Sign In</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div id="chatInterface" class="hidden h-screen flex flex-col" style="position: relative;">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 py-4 px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-xl font-semibold text-gray-800">AI Assistant</h1>
                <div id="currentModelDisplay" class="hidden">
                    <span class="text-sm text-gray-500">Модель:</span>
                    <span id="currentModelName" class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Загрузка...
                    </span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleLanguage()" class="flex items-center gap-2 px-4 py-2 rounded-full border border-gray-300">
                    <span id="chatLanguageLabel">EN</span>
                    <i data-feather="globe"></i>
                </button>
                <button onclick="newChatUI()" class="px-3 py-2 rounded-full border border-gray-300 hover:bg-gray-100">
                    New Chat
                </button>
                <button onclick="showAdminPanel()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="settings"></i>
                </button>
                <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="log-out"></i>
                </button>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <!-- Left Sidebar - Chat History -->
            <div class="w-80 bg-gray-50 border-r border-gray-200 flex flex-col">
                <div class="p-4 border-b border-gray-200">
                    <h3 class="text-sm font-semibold text-gray-700">Chat History</h3>
                </div>
                <div class="flex-1 overflow-y-auto p-4" id="chatHistory">
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="message-square" class="w-8 h-8 mx-auto text-gray-300"></i>
                        <p class="mt-2 text-sm">No chat history</p>
                    </div>
                </div>
            </div>
            
            <!-- Center - Chat Messages -->
            <div class="flex-1 flex flex-col">
                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4" id="chatArea">
                    <!-- Messages will appear here -->
                    <div class="text-center py-8 text-gray-500" id="emptyState">
                        <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                        <p class="mt-4" id="welcomeMessage">Start a conversation with the AI assistant</p>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="border-t border-gray-200 p-4 bg-white">
                    <div class="relative">
                        <textarea id="messageInput" rows="2" class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none" placeholder="Type your message..."></textarea>
                        <button id="sendButton" onclick="sendMessage()" class="absolute right-3 bottom-3 p-2 rounded-full bg-blue-600 text-white hover:bg-blue-700">
                            <i data-feather="send"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-white z-50 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Admin Panel</h2>
                <button onclick="hideAdminPanel()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <!-- Табы для переключения между статьями и документами -->
            <div class="mb-6">
                <div class="flex border-b border-gray-200">
                    <button id="articlesTab" onclick="showArticlesTab()" class="px-4 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600">
                        Статьи
                    </button>
                    <button id="documentsTab" onclick="showDocumentsTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Документы
                    </button>
                    <button id="aiTab" onclick="showAiTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        AI
                    </button>
                    <button id="usersTab" onclick="showUsersTab()" class="px-4 py-2 text-sm font-medium text-gray-500 hover:text-gray-700">
                        Пользователи
                    </button>
                </div>
            </div>

            <!-- Секция статей -->
            <div id="articlesSection" class="mb-6 relative">
                <div class="flex justify_between items-center">
                    <h3 class="text-lg font-semibold">Knowledge Base Articles</h3>
                    <div class="flex gap-2">
                        <button onclick="showCreateArticleModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="plus"></i>
                            <span>Create Article</span>
                        </button>
                        <button onclick="showImportModal()" class="flex items-center gap-2 px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900">
                            <i data-feather="upload"></i>
                            <span>Import JSON</span>
                        </button>
                        <button onclick="reindex()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Reindex</span>
                        </button>
                        <button onclick="generateMetaSelected()" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            <i data-feather="zap"></i>
                            <span>Generate Tags & Category</span>
                        </button>
                    </div>
                </div>
                
                <div id="articlesContainer" class="mt-4 overflow-auto" style="max-height: calc(100vh - 260px);">
                    <table id="articlesTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="articlesTableBody">
                            <!-- Articles will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <!-- Fixed header clone and bottom scroll mirror for wide tables -->
                <div id="adminHeaderClone" class="hidden z-50" style="position: fixed; top: 0; left: 0; right: 0; background: #f9fafb; border-bottom: 1px solid #e5e7eb; pointer-events: none;">
                    <div id="adminHeaderScroller" style="overflow: hidden; width: 100%;">
                        <!-- cloned table head will be inserted here -->
                    </div>
                </div>
                <div id="adminScrollMirror" class="hidden h-3 overflow-x-auto z-40" style="background: rgba(249,250,251,0.85); position: fixed; left: 0; right: 0; bottom: 0; border-top: 1px solid #e5e7eb;">
                    <div id="adminScrollSpacer" style="height:1px; width:0;"></div>
                </div>
            </div>

            <!-- Секция документов -->
            <div id="documentsSection" class="mb-6 relative hidden">
                <div class="flex justify_between items-center">
                    <h3 class="text-lg font-semibold">Документы</h3>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showUploadDocumentModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="upload"></i>
                            <span>Загрузить документ</span>
                        </button>
                        <button onclick="processAllDocuments()" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i data-feather="refresh-cw"></i>
                            <span>Обработать все</span>
                        </button>
                        <button onclick="generateCategoriesForSelected()" class="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                            <i data-feather="tag"></i>
                            <span>Генерировать категории</span>
                        </button>
                        <button onclick="generateTagsForSelected()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            <i data-feather="hash"></i>
                            <span>Генерировать теги</span>
                        </button>
                        <button onclick="generateAllMetaForSelected()" class="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                            <i data-feather="zap"></i>
                            <span>Генерировать все метаданные</span>
                        </button>
                        <button onclick="deleteSelectedDocuments()" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i data-feather="trash-2"></i>
                            <span>Удалить выбранные</span>
                        </button>
                    </div>
                </div>
                
                <div id="documentsContainer" class="mt-4 overflow-auto" style="max-height: calc(100vh - 260px);">
                    <table id="documentsTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllDocuments" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="toggleAllDocuments()">
                                </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Файл</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Тема</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Путь</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Теги</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Загружен</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="documentsTableBody">
                            <!-- Документы будут загружены здесь -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Секция AI -->
            <div id="aiSection" class="mb-6 relative hidden">
                <div class="space-y-6">
                    <!-- Текущие настройки -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-blue-800 mb-4">Текущие настройки</h3>
                        <div id="currentSettings" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">Модель для ответов:</span>
                                <span id="currentResponseModel" class="text-sm text-gray-600">Не выбрана</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">Модель для эмбеддингов:</span>
                                <span id="currentEmbeddingModel" class="text-sm text-gray-600">Не выбрана</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-medium text-gray-700">API сервис:</span>
                                <span id="currentApiService" class="text-sm text-gray-600">Не настроен</span>
                            </div>
                        </div>
                    </div>

                    <!-- API ключи -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">API ключи</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Сервис</label>
                                <select id="apiService" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="mistral">Mistral AI</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                    <option value="google">Google AI</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">API ключ</label>
                                <div class="flex gap-2">
                                    <input type="password" id="apiKey" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Введите API ключ">
                                    <button onclick="toggleApiKeyVisibility()" class="px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50">
                                        <i data-feather="eye" id="apiKeyToggleIcon"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Сохранить ключ
                                </button>
                                <button onclick="testApiConnection()" class="ml-2 px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                    Тестировать подключение
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Локальные модели -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Локальные модели (Ollama)</h3>
                        <div class="space-y-4">
                            <div class="flex gap-2">
                                <button onclick="loadOllamaModels()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i data-feather="refresh-cw" class="w-4 h-4 mr-2"></i>
                                    Загрузить модели
                                </button>
                                <button onclick="checkOllamaStatus()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    <i data-feather="activity" class="w-4 h-4 mr-2"></i>
                                    Проверить статус
                                </button>
                            </div>
                            <div id="ollamaModelsList" class="space-y-2">
                                <!-- Модели будут загружены здесь -->
                            </div>
                        </div>
                    </div>

                    <!-- Настройки моделей -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Настройки моделей</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Модель для ответов</label>
                                <select id="responseModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Выберите модель</option>
                                </select>
                                <div class="mt-1">
                                    <button onclick="testModel('response')" class="text-xs text-blue-600 hover:text-blue-800">
                                        Тестировать модель
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Модель для эмбеддингов</label>
                                <select id="embeddingModel" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Выберите модель</option>
                                </select>
                                <div class="mt-1">
                                    <button onclick="testModel('embedding')" class="text-xs text-blue-600 hover:text-blue-800">
                                        Тестировать модель
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-2">
                            <button onclick="saveModelSettings()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                Сохранить настройки
                            </button>
                            <button onclick="loadCurrentSettings()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                Загрузить текущие
                            </button>
                        </div>
                    </div>

                    <!-- Статус подключения -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Статус подключения</h3>
                        <div id="connectionStatus" class="space-y-2">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full" id="apiStatusIndicator"></div>
                                <span id="apiStatusText">API: Не подключен</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-gray-400 rounded-full" id="ollamaStatusIndicator"></div>
                                <span id="ollamaStatusText">Ollama: Не подключен</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Секция пользователей -->
            <div id="usersSection" class="mb-6 relative hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Пользователи</h3>
                    <div class="flex gap-2">
                        <button onclick="showCreateUserModal()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i data-feather="user-plus"></i>
                            <span>Создать пользователя</span>
                        </button>
                    </div>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Имя</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Роль</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Создан</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="usersTableBody">
                            <!-- Пользователи будут загружены здесь -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Article Modal -->
    <div id="createArticleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Create New Article</h2>
                <button onclick="hideCreateArticleModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="articleTitle" class="block text_sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="articleTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="articleCategory" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="articleCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select a category</option>
                        <!-- Categories will be loaded here -->
                    </select>
                </div>
                
                <div>
                    <label for="articleTags" class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg" id="tagsContainer">
                        <!-- Tags will be added here -->
                    </div>
                    <div class="mt-1 flex">
                        <input type="text" id="newTagInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Add new tag">
                        <button onclick="addTag()" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">Add</button>
                    </div>
                </div>
                
                <div>
                    <label for="articleContent" class="block text-sm font-medium text-gray-700 mb-1">Content</label>
                    <textarea id="articleContent" rows="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideCreateArticleModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button onclick="saveArticle()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Article</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Upload Document Modal -->
    <div id="uploadDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Загрузить документ</h2>
                <button onclick="hideUploadDocumentModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="documentFile" class="block text-sm font-medium text-gray-700 mb-1">Файл документа</label>
                    <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.txt" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Поддерживаемые форматы: PDF, DOC, DOCX, TXT (максимум 50MB)</p>
                </div>
                
                <div>
                    <label for="documentLanguage" class="block text-sm font-medium text-gray-700 mb-1">Язык документа</label>
                    <select id="documentLanguage" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="ru">Русский</option>
                        <option value="en">English</option>
                    </select>
                </div>
                
                <div>
                    <label for="documentPath" class="block text-sm font-medium text-gray-700 mb-1">Путь к файлу (необязательно)</label>
                    <input type="text" id="documentPath" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Например: /documents/manuals/office2016/">
                    <p class="text-xs text-gray-500 mt-1">Укажите путь для контекста поиска (будет включен в эмбеддинги)</p>
                </div>
                
                <div>
                    <label for="documentCategory" class="block text-sm font-medium text-gray-700 mb-1">Категория</label>
                    <select id="documentCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Выберите категорию</option>
                        <!-- Категории будут загружены здесь -->
                    </select>
                </div>
                
                <div>
                    <label for="documentTags" class="block text-sm font-medium text-gray-700 mb-1">Теги</label>
                    <div class="flex flex-wrap gap-2 p-2 border border-gray-300 rounded-lg" id="documentTagsContainer">
                        <!-- Теги будут добавлены здесь -->
                    </div>
                    <div class="mt-1 flex">
                        <input type="text" id="newDocumentTagInput" class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Добавить тег">
                        <button onclick="addDocumentTag()" class="px-4 py-2 bg-blue-600 text-white rounded-r-lg hover:bg-blue-700">Добавить</button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideUploadDocumentModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Отмена</button>
                    <button onclick="uploadDocument()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Загрузить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Создать пользователя</h2>
                <button onclick="hideCreateUserModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="userEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="user@example.com">
                </div>
                
                <div>
                    <label for="userFullName" class="block text-sm font-medium text-gray-700 mb-1">Полное имя</label>
                    <input type="text" id="userFullName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Иван Иванов">
                </div>
                
                <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">Пароль</label>
                    <input type="password" id="userPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Минимум 6 символов">
                </div>
                
                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700 mb-1">Роль</label>
                    <select id="userRole" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <option value="user">Пользователь</option>
                        <option value="admin">Администратор</option>
                    </select>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideCreateUserModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Отмена</button>
                    <button onclick="createUser()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Создать пользователя</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sources side panel (fixed outside chat on the right) -->
    <div id="sourcesPanel" class="hidden fixed bg-white shadow-xl border border-gray-200 rounded-lg" style="z-index: 10000; pointer-events: auto; width: 400px; top: 80px; right: 20px; max-height: calc(100vh - 100px);">
        <div class="flex items-center justify-between p-3 border-b border-gray-200">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                <div role="heading" class="font-semibold text-gray-800">Search results</div>
            </div>
            <button onclick="hideSourcesPanel()" class="p-1 rounded-full hover:bg-gray-100 transition-colors">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M14.1167 13.197L13.1969 14.1168L1.88324 2.80309L2.80303 1.8833L14.1167 13.197Z" fill="currentColor"></path>
                    <path d="M13.1969 1.88331L14.1167 2.8031L2.80303 14.1168L1.88324 13.197L13.1969 1.88331Z" fill="currentColor"></path>
                </svg>
            </button>
        </div>
        <div class="h-[calc(100%-60px)] overflow-y-auto">
            <div id="sourcesList" class="p-3 space-y-3"></div>
        </div>
    </div>

    <!-- Chunks Modal -->
    <div id="chunksModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Чанки документа</h2>
                <button onclick="hideChunksModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div id="chunksList" class="space-y-4">
                <!-- Чанки будут загружены здесь -->
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editDocumentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Редактировать документ</h2>
                <button onclick="hideEditDocumentModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="editDocumentTitle" class="block text-sm font-medium text-gray-700 mb-1">Заголовок</label>
                    <input type="text" id="editDocumentTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="editDocumentTopic" class="block text-sm font-medium text-gray-700 mb-1">Тема</label>
                    <input type="text" id="editDocumentTopic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="editDocumentPath" class="block text-sm font-medium text-gray-700 mb-1">Путь к файлу</label>
                    <input type="text" id="editDocumentPath" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Например: /documents/manuals/office2016/">
                    <p class="text-xs text-gray-500 mt-1">Путь для контекста поиска</p>
                </div>
                
                <div>
                    <label for="editDocumentSummary" class="block text-sm font-medium text-gray-700 mb-1">Краткое содержание</label>
                    <textarea id="editDocumentSummary" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end gap-3 pt-4">
                    <button onclick="hideEditDocumentModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Отмена
                    </button>
                    <button onclick="saveDocumentChanges()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Сохранить изменения
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Articles Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 w-full max-w-6xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Импорт статей из JSON</h2>
                <button onclick="hideImportModal()" class="p-2 rounded-full hover:bg-gray-100">
                    <i data-feather="x"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Шаг 1: Загрузка файла -->
                <div id="importStep1" class="space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 1: Загрузка JSON файла</h3>
                    <div>
                        <label for="importFile" class="block text-sm font-medium text-gray-700 mb-1">JSON файл</label>
                        <input type="file" id="importFile" accept=".json" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Выберите JSON файл с массивом объектов</p>
                    </div>
                    <button onclick="analyzeImportFile()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Анализировать файл
                    </button>
                </div>
                
                <!-- Шаг 2: Настройка сопоставления полей -->
                <div id="importStep2" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 2: Сопоставление полей</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600 mb-4">Найдено записей: <span id="importRecordCount">0</span></p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="fieldMappingContainer">
                            <!-- Сопоставления полей будут загружены здесь -->
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="showImportStep1()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Назад
                        </button>
                        <button onclick="startImport()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Начать импорт
                        </button>
                    </div>
                </div>
                
                <!-- Шаг 3: Результат импорта -->
                <div id="importStep3" class="hidden space-y-4">
                    <h3 class="text-lg font-semibold">Шаг 3: Результат импорта</h3>
                    <div id="importResults" class="bg-gray-50 p-4 rounded-lg">
                        <!-- Результаты импорта будут показаны здесь -->
                    </div>
                    <button onclick="hideImportModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Закрыть
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize libraries
        AOS.init();
        feather.replace();
        
        // Language state (true for English, false for Russian)
        let isEnglish = true;

        // API base
        const API_BASE = 'http://localhost:8000';
        
        // Current user info
        let currentUser = null;
        
        // UI Texts
        const uiTexts = {
            en: {
                ssoText: "Sign in with Corporate SSO",
                orText: "OR",
                emailLabel: "Email",
                passwordLabel: "Password",
                signInText: "Sign In",
                welcomeMessage: "Start a conversation with the AI assistant",
                typing: "AI is typing...",
                feedbackPlaceholder: "What was wrong with this response?",
                submitFeedback: "Submit",
                cancelFeedback: "Cancel",
                adminPanelTitle: "Admin Panel",
                createArticle: "Create Article",
                importJson: "Import JSON",
                reindex: "Reindex",
                articleTitle: "Title",
                articleCategory: "Category",
                articleTags: "Tags",
                articleContent: "Content",
                addTag: "Add",
                cancel: "Cancel",
                saveArticle: "Save Article",
                importFile: "JSON File",
                importMode: "Import Mode",
                addNewOnly: "Add new articles only",
                updateAndAdd: "Update existing and add new",
                replaceAll: "Replace all articles",
                processImport: "Import"
            },
            ru: {
                ssoText: "Войти через корпоративный SSO",
                orText: "ИЛИ",
                emailLabel: "Электронная почта",
                passwordLabel: "Пароль",
                signInText: "Войти",
                welcomeMessage: "Начните диалог с AI ассистентом",
                typing: "AI печатает...",
                feedbackPlaceholder: "Что не так с этим ответом?",
                submitFeedback: "Отправить",
                cancelFeedback: "Отмена",
                adminPanelTitle: "Административная панель",
                createArticle: "Создать статью",
                importJson: "Импорт JSON",
                reindex: "Переиндексировать",
                articleTitle: "Заголовок",
                articleCategory: "Категория",
                articleTags: "Теги",
                articleContent: "Содержание",
                addTag: "Добавить",
                cancel: "Отмена",
                saveArticle: "Сохранить статью",
                importFile: "JSON файл",
                importMode: "Режим импорта",
                addNewOnly: "Только новые статьи",
                updateAndAdd: "Обновить существующие и добавить новые",
                replaceAll: "Заменить все статьи",
                processImport: "Импортировать"
            }
        };
        
        // Update UI language
        function updateUILanguage() {
            const lang = isEnglish ? 'en' : 'ru';
            const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
            setText('languageLabel', isEnglish ? 'EN' : 'RU');
            setText('chatLanguageLabel', isEnglish ? 'EN' : 'RU');
            setText('ssoText', uiTexts[lang].ssoText);
            setText('orText', uiTexts[lang].orText);
            setText('emailLabel', uiTexts[lang].emailLabel);
            setText('passwordLabel', uiTexts[lang].passwordLabel);
            setText('signInText', uiTexts[lang].signInText);
            setText('welcomeMessage', uiTexts[lang].welcomeMessage);
        }
        
        // Toggle language
        function toggleLanguage() {
            isEnglish = !isEnglish;
            updateUILanguage();
        }
        
        // Simulate login
        function ssoLogin() {
            // In a real app, this would redirect to SSO provider
            simulateLogin();
        }
        
        async function emailLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                alert(isEnglish ? "Please enter email and password" : "Пожалуйста, введите email и пароль");
                return;
            }
            try {
                const form = new URLSearchParams();
                form.append('username', email);
                form.append('password', password);
                form.append('grant_type', 'password');

                const res = await fetch(API_BASE + '/api/auth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form
                });
                if (!res.ok) throw new Error('Auth failed');
                const data = await res.json();
                window.localStorage.setItem('token', data.access_token);
                await loadCurrentUser(); // Загружаем информацию о пользователе
                simulateLogin();
            } catch (e) {
                alert(isEnglish ? 'Invalid credentials' : 'Неверные учетные данные');
            }
        }
        
        function simulateLogin() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('chatInterface').classList.remove('hidden');
            
            // Загружаем текущую модель
            loadCurrentModel();
            
            // For demo, show a welcome message
            setTimeout(() => {
                addAIMessage(isEnglish ? 
                    "Hello! I'm your AI assistant. How can I help you today?" : 
                    "Здравствуйте! Я ваш AI помощник. Чем могу помочь?");
            }, 500);
        }
        
        async function autoLogin() {
            try {
                const formData = new URLSearchParams();
                formData.append('username', 'admin@example.com');
                formData.append('password', 'admin');
                
                const res = await fetch(API_BASE + '/api/auth/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                
                if (res.ok) {
                    const data = await res.json();
                    window.localStorage.setItem('token', data.access_token);
                    await loadCurrentUser(); // Загружаем информацию о пользователе
                    console.log('✅ Автоматическая аутентификация успешна');
                } else {
                    console.log('❌ Автоматическая аутентификация не удалась');
                }
            } catch (e) {
                console.log('❌ Ошибка автоматической аутентификации:', e);
            }
        }
        
        function logout() {
            document.getElementById('chatInterface').classList.add('hidden');
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            currentUser = null; // Очищаем информацию о пользователе
            document.getElementById('chatArea').innerHTML = `
                <div class="text-center py-8 text-gray-500" id="emptyState">
                    <i data-feather="message-square" class="w-12 h-12 mx-auto text-gray-300"></i>
                    <p class="mt-4">${isEnglish ? uiTexts.en.welcomeMessage : uiTexts.ru.welcomeMessage}</p>
                </div>
            `;
            feather.replace();
        }
        
        // Chat functions
        function authHeader(){
            const t = window.localStorage.getItem('token');
            console.log('Токен аутентификации:', t ? 'найден' : 'не найден');
            return t ? { 'Authorization': 'Bearer ' + t } : {};
        }

        // User management functions
        async function loadCurrentUser() {
            try {
                const res = await fetch(API_BASE + '/api/auth/me', { 
                    headers: { ...authHeader() } 
                });
                if (res.ok) {
                    currentUser = await res.json();
                    console.log('Текущий пользователь:', currentUser);
                    updateUIForUserRole();
                } else {
                    currentUser = null;
                }
            } catch (e) {
                console.error('Ошибка загрузки пользователя:', e);
                currentUser = null;
            }
        }

        function isAdmin() {
            return currentUser && currentUser.role === 'admin';
        }

        function updateUIForUserRole() {
            const adminButton = document.querySelector('button[onclick="showAdminPanel()"]');
            if (adminButton) {
                if (isAdmin()) {
                    adminButton.style.display = 'block';
                } else {
                    adminButton.style.display = 'none';
                }
            }
        }

        // Безопасная экранизация HTML
        function escapeHtml(value) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return String(value || '').replace(/[&<>"']/g, (m) => map[m]);
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message) {
                // Очищаем старые мини-бары источников
                const chat = document.getElementById('chatArea');
                if (chat) {
                    const oldBars = chat.querySelectorAll('[id^="refbar-"]');
                    oldBars.forEach(bar => bar.remove());
                }
                
                // Очищаем localStorage только если это первое сообщение пользователя
                const userMessages = chat.querySelectorAll('.message.user');
                if (userMessages.length === 0) {
                    console.log('First user message, clearing localStorage');
                    localStorage.removeItem('lastSources');
                    localStorage.removeItem('lastSourcesCount');
                    localStorage.removeItem('lastSourcesIcons');
                }
                
                addUserMessage(message);
                input.value = '';
                
                // Show typing indicator
                const typingId = 'typing-' + Date.now();
                document.getElementById('emptyState')?.remove();
                if (chat) chat.innerHTML += `
                    <div id="${typingId}" class="flex items-center gap-2 text-gray-500">
                        <div class="typing-indicator">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                        <span>${isEnglish ? uiTexts.en.typing : uiTexts.ru.typing}</span>
                    </div>
                `;
                if (chat) chat.scrollTop = chat.scrollHeight;
                try {
                    const res = await fetch(API_BASE + '/api/chat/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify({ message, user_id: 'web-user' })
                    });
                    const data = await res.json();
                    const ti = document.getElementById(typingId);
                    if (ti) ti.remove();
                    
                    // Отладочная информация
                    console.log('Response data:', data);
                    console.log('Related articles:', data.related_articles);
                    console.log('Related documents:', data.related_documents);
                    
                    // Рендер мини-бара источников (статьи + документы)
                    const hasArticles = Array.isArray(data.related_articles) && data.related_articles.length > 0;
                    const hasDocuments = Array.isArray(data.related_documents) && data.related_documents.length > 0;
                    
                    console.log('Has articles:', hasArticles, 'Has documents:', hasDocuments);
                    
                    if (hasArticles || hasDocuments) {
                        console.log('Rendering sources bar with', data.related_articles?.length || 0, 'articles and', data.related_documents?.length || 0, 'documents');
                        renderSourcesBar(
                            hasArticles ? data.related_articles : [],
                            hasDocuments ? data.related_documents : []
                        );
                    } else {
                        console.log('No sources to display');
                    }
                    addAIMessage(escapeHtml(data.response || ''), data.model_info);
                } catch (e) {
                    const ti = document.getElementById(typingId);
                    if (ti) ti.remove();
                    addAIMessage(escapeHtml(isEnglish ? 'Error. Try again.' : 'Ошибка. Повторите попытку.'));
                }
            }
        }
        
        // Источники: мини-бар над ответом и панель с карточками
        function renderSourcesBar(articles, documents = []) {
            console.log('renderSourcesBar called with:', { articles, documents });
            const chat = document.getElementById('chatArea');
            if (!chat || (!Array.isArray(articles) || articles.length === 0) && (!Array.isArray(documents) || documents.length === 0)) {
                console.log('No sources to render or chat area not found');
                return;
            }
            
            const totalCount = (articles?.length || 0) + (documents?.length || 0);
            const hostIcons = [];
            
            // Иконки для статей
            if (articles && articles.length > 0) {
                const articleIcons = articles.slice(0, 4).map((a, idx) => {
                    try {
                        const u = (a.url || '').startsWith('http') ? new URL(a.url) : null;
                        const host = u ? u.hostname : 'kb.local';
                        const icon = u ? `https://www.google.com/s2/favicons?sz=64&domain=${u.hostname}` : '';
                        const imgTag = icon ? `<img src="${icon}" alt="${host}" class="w-4 h-4 rounded-sm" onerror="this.style.display='none'">` : '';
                        return `<div class="flex items-center justify-center w-4 h-4">${imgTag}</div>`;
                    } catch { return ''; }
                });
                hostIcons.push(...articleIcons);
            }
            
            // Иконки для документов
            if (documents && documents.length > 0) {
                const docIcons = documents.slice(0, 4).map((doc, idx) => {
                    return `<div class="flex items-center justify-center w-4 h-4"><span class="text-xs text-blue-600">📄</span></div>`;
                });
                hostIcons.push(...docIcons);
            }

            const barId = 'refbar-' + Date.now();
            chat.innerHTML += `
                <div id="${barId}" class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer select-none hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-blue-50" role="button" tabindex="0">
                    <div class="flex items-center justify-center w-4 h-4">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M0.300842 6.75896C0.300842 3.2391 3.15501 0.384938 6.67487 0.384938C6.98421 0.384956 7.28876 0.407574 7.58698 0.450368L7.49518 1.09392L7.4024 1.73748C7.16512 1.70342 6.92228 1.68574 6.67487 1.68572C3.87298 1.68572 1.60162 3.95707 1.60162 6.75896C1.60182 9.56068 3.8731 11.8322 6.67487 11.8322C9.0556 11.832 11.0549 10.1909 11.6006 7.97771L12.2315 8.13299L12.8624 8.28924C12.1767 11.0694 9.66758 13.1318 6.67487 13.132C3.15513 13.132 0.301038 10.2787 0.300842 6.75896Z" fill="currentColor"></path>
                            <path d="M15.6992 14.8074L14.7793 15.7274L11.3974 12.3455L12.3174 11.4256L15.6992 14.8074Z" fill="currentColor"></path>
                            <path d="M11.3473 6.59701C11.2764 6.81246 10.9716 6.81246 10.9008 6.59701L10.4901 5.34822C10.3035 4.78103 9.85867 4.33617 9.29148 4.14962L8.04269 3.73893C7.82724 3.66807 7.82724 3.36329 8.04269 3.29243L9.29148 2.88173C9.85867 2.69519 10.3035 2.25032 10.4901 1.68314L10.9008 0.434345C10.9716 0.218896 11.2764 0.218896 11.3473 0.434345L11.758 1.68314C11.9445 2.25032 12.3894 2.69519 12.9566 2.88173L14.2054 3.29243C14.4208 3.36329 14.4208 3.66807 14.2054 3.73893L12.9566 4.14962C12.3894 4.33617 11.9445 4.78103 11.758 5.34822L11.3473 6.59701Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <span class="font-medium">${isEnglish ? 'Found' : 'Найдено'} ${totalCount} ${isEnglish ? 'sources' : 'источников'}</span>
                    <div class="flex items-center gap-1 ml-auto">${hostIcons.join('')}</div>
                </div>
            `;
            
            // Плавный скролл к концу
            setTimeout(() => {
                chat.scrollTo({
                    top: chat.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
            
            // Сохраняем данные для панели источников
            const allSources = [];
            if (articles && articles.length > 0) {
                allSources.push(...articles.map(art => ({
                    type: 'article',
                    url: art.url || '',
                    title: (art.title || '').slice(0, 80),
                    snippet: (art.text || '').slice(0, 200),
                    id: art.id
                })));
            }
            if (documents && documents.length > 0) {
                allSources.push(...documents.map(doc => ({
                    type: 'document',
                    title: (doc.title || doc.original_filename || '').slice(0, 80),
                    snippet: (doc.topic || doc.summary || '').slice(0, 200),
                    path: doc.path || '',
                    id: doc.id
                })));
            }
            window.__lastSources = allSources;
            
            // Сохраняем данные в localStorage для восстановления при обновлении
            console.log('Saving to localStorage:', { allSources, totalCount, hostIcons });
            localStorage.setItem('lastSources', JSON.stringify(allSources));
            localStorage.setItem('lastSourcesCount', totalCount.toString());
            localStorage.setItem('lastSourcesIcons', JSON.stringify(hostIcons));
            
            // Обработчик клика на весь бар
            const barEl = document.getElementById(barId);
            if (barEl) {
                const handler = function(ev){
                    console.log('Sources bar clicked');
                    ev.preventDefault();
                    ev.stopPropagation();
                    // Открываем UI источников (панель справа или модалка)
                    showSourcesUI();
                };
                barEl.addEventListener('click', handler);
                barEl.addEventListener('keydown', function(ev){ 
                    if (ev.key === 'Enter' || ev.key === ' ') { 
                        handler(ev); 
                    } 
                });
            }
        }


        function positionSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (!panel) return;
            
            // Panel is now fixed positioned on the right side
            // No need to calculate position dynamically
            panel.style.top = '80px';
            panel.style.right = '20px';
            panel.style.left = 'auto';
            panel.style.width = '400px';
            panel.style.maxHeight = 'calc(100vh - 100px)';
        }

        function showSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            const list = document.getElementById('sourcesList');
            if (!panel || !list) return;
            
            const items = Array.isArray(window.__lastSources) ? window.__lastSources : [];
            if (items.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">No sources available</div>';
                panel.classList.remove('hidden');
                return;
            }
            
            list.innerHTML = items.map((it, idx) => {
                // Обработка документов
                if (it.type === 'document') {
                    const host = it.path || 'Документ';
                    const icon = '<span class="text-xs text-blue-600">📄</span>';
                    
                    // Если есть URL, используем его для перехода, иначе открываем просмотр
                    const hasUrl = it.url && it.url.startsWith('http');
                    const href = hasUrl ? it.url : '#';
                    const onclickAttr = hasUrl ? '' : `onclick="event.preventDefault(); viewDocument(${it.id});"`;
                    const targetAttr = hasUrl ? 'target="_blank" rel="noreferrer"' : '';
                    
                    return `
                        <a href="${href}" ${onclickAttr} ${targetAttr} class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all">
                            <div class="flex items-start gap-3">
                                <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                                    <div class="w-4 h-4 bg-blue-100 rounded flex items-center justify-center">
                                        ${icon}
                                    </div>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                        <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                    </div>
                                    <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                    <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                                </div>
                            </div>
                        </a>`;
                }
                
                // Обработка статей
                const host = (() => { 
                    try { 
                        return it.url ? new URL(it.url).hostname : 'kb.local'; 
                    } catch { 
                        return 'kb.local'; 
                    } 
                })();
                const icon = (() => { 
                    try { 
                        return it.url ? `https://www.google.com/s2/favicons?sz=64&domain=${new URL(it.url).hostname}` : ''; 
                    } catch { 
                        return ''; 
                    } 
                })();
                const href = it.url && it.url.startsWith('http') ? it.url : '#';
                
                return `
                    <a href="${href}" target="_blank" rel="noreferrer" class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-6 h-6 flex items-center justify-center">
                                ${icon ? `<img src="${icon}" class="w-4 h-4 rounded-sm" onerror="this.style.display='none'">` : ''}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                </div>
                                <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                            </div>
                        </div>
                    </a>`;
            }).join('');
            positionSourcesPanel();
            panel.classList.remove('hidden');
            panel.style.display = 'block';
            
            // Плавный скролл к началу панели источников
            setTimeout(() => {
                const scrollContainer = panel.querySelector('.h-\\[calc\\(100\\%-60px\\)\\]');
                if (scrollContainer) {
                    scrollContainer.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            }, 100);
            
            console.log('Sources panel shown with', items.length, 'items');
        }

        function hideSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (panel) {
                panel.classList.add('hidden');
                panel.style.display = 'none';
                console.log('Sources panel hidden');
            }
        }
        
        function toggleSourcesPanel() {
            const panel = document.getElementById('sourcesPanel');
            if (!panel) {
                console.error('Sources panel not found');
                return;
            }
            
            if (panel.classList.contains('hidden')) {
                showSourcesPanel();
            } else {
                hideSourcesPanel();
            }
        }

        // Источники: модальное окно как запасной вариант и для узких экранов
        function showSourcesModal() {
            let modal = document.getElementById('sourcesModal');
            if (!modal) {
                const wrapper = document.createElement('div');
                wrapper.id = 'sourcesModal';
                wrapper.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
                wrapper.innerHTML = `
                    <div class="bg-white w-full max-w-md max-h-[80vh] rounded-lg shadow-xl overflow-hidden">
                        <div class="flex items-center justify-between p-3 border-b border-gray-200">
                            <div class="font-semibold">Search results</div>
                            <button id="sourcesModalClose" class="p-1 rounded hover:bg-gray-100" aria-label="Close">✕</button>
                        </div>
                        <div class="p-3 overflow-y-auto" id="sourcesModalList"></div>
                    </div>`;
                document.body.appendChild(wrapper);
                document.getElementById('sourcesModalClose').onclick = hideSourcesModal;
                modal = wrapper;
            }

            const listEl = document.getElementById('sourcesModalList');
            const items = Array.isArray(window.__lastSources) ? window.__lastSources : [];
            listEl.innerHTML = items.length ? items.map((it, idx) => {
                const host = (() => { try { return it.url ? new URL(it.url).hostname : 'kb.local'; } catch { return 'kb.local'; } })();
                const icon = (() => { try { return it.url ? `https://www.google.com/s2/favicons?sz=64&domain=${new URL(it.url).hostname}` : ''; } catch { return ''; } })();
                const href = it.url && it.url.startsWith('http') ? it.url : '#';
                return `
                    <a href="${href}" target="_blank" rel="noreferrer" class="block p-3 rounded-lg border border-gray-200 hover:border-blue-300 hover:bg-blue-50 transition-all mb-2">
                        <div class="flex items-start gap-3">
                            <div class="w-5 h-5 flex items-center justify-center">${icon ? `<img src="${icon}" class="w-4 h-4" onerror="this.style.display='none'">` : ''}</div>
                            <div class="min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs text-gray-500 font-medium">${escapeHtml(host)}</span>
                                    <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">${idx+1}</span>
                                </div>
                                <div class="font-medium text-gray-900 text-sm mb-1 line-clamp-2">${escapeHtml(it.title)}</div>
                                <div class="text-xs text-gray-600 line-clamp-3">${escapeHtml(it.snippet)}</div>
                            </div>
                        </div>
                    </a>`;
            }).join('') : '<div class="text-center text-gray-500 py-8">No sources available</div>';

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function hideSourcesModal() {
            const modal = document.getElementById('sourcesModal');
            if (modal) { modal.classList.add('hidden'); modal.style.display = 'none'; }
        }

        function showSourcesUI() {
            // Для узких экранов открываем модалку, иначе правую панель
            if (window.innerWidth < 1024) {
                hideSourcesPanel();
                showSourcesModal();
            } else {
                hideSourcesModal();
                showSourcesPanel();
                
                // Плавный скролл к панели источников
                setTimeout(() => {
                    const panel = document.getElementById('sourcesPanel');
                    if (panel) {
                        panel.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    }
                }, 200);
            }
        }

        function addUserMessage(text) {
            document.getElementById('emptyState')?.remove();
            document.getElementById('chatArea').innerHTML += `
                <div class="flex justify-end">
                    <div class="max-w-3/4 px-4 py-3 chat-bubble-user">
                        ${text}
                    </div>
                </div>
            `;
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
            feather.replace();
        }
        
        function addAIMessage(text, modelInfo = null) {
            const messageId = 'msg-' + Date.now();
            const chat = document.getElementById('chatArea');
            if (!chat) return;
            const html = renderRichContent(text);
            
            // Создаем информацию о модели
            let modelInfoHtml = '';
            if (modelInfo && modelInfo.display_name) {
                const modelType = modelInfo.model_type || 'unknown';
                const modelName = modelInfo.display_name || 'Unknown Model';
                const typeColors = {
                    'mistral': 'bg-blue-100 text-blue-800',
                    'openai': 'bg-green-100 text-green-800',
                    'anthropic': 'bg-purple-100 text-purple-800',
                    'ollama': 'bg-orange-100 text-orange-800',
                    'unknown': 'bg-gray-100 text-gray-800'
                };
                const colorClass = typeColors[modelType] || typeColors['unknown'];
                
                modelInfoHtml = `
                    <div class="flex items-center gap-2 mt-2 pt-2 border-t border-gray-200">
                        <span class="text-xs text-gray-500">Модель:</span>
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${colorClass}">
                            ${modelName}
                        </span>
                    </div>
                `;
            }
            
            chat.innerHTML += `
                <div id="${messageId}" class="flex justify-start">
                    <div class="max-w-3/4 px-4 py-3 chat-bubble-ai">
                        ${html}
                        <div class="flex justify-end mt-2 gap-2">
                            <button onclick="rateResponse('${messageId}', true)" class="p-1 rounded-full hover:bg-gray-200">
                                <i data-feather="thumbs-up" class="w-4 h-4"></i>
                            </button>
                            <button onclick="rateResponse('${messageId}', false)" class="p-1 rounded-full hover:bg-gray-200">
                                <i data-feather="thumbs-down" class="w-4 h-4"></i>
                            </button>
                        </div>
                        ${modelInfoHtml}
                    </div>
                </div>
            `;
            chat.scrollTop = chat.scrollHeight;
            feather.replace();
            // highlight code
            try { document.querySelectorAll('pre code').forEach(el => window.hljs && hljs.highlightElement(el)); } catch {}
        }
        
        function generateAIResponse(userMessage) {
            const lang = isEnglish ? 'en' : 'ru';
            if (userMessage.toLowerCase().includes('help') || userMessage.toLowerCase().includes('помощь')) {
                return lang === 'en' ? 
                    "I can help you with various topics. Try asking me about company policies, technical issues, or general information." : 
                    "Я могу помочь с различными вопросами. Спросите меня о политике компании, технических проблемах или общей информации.";
            } else if (userMessage.toLowerCase().includes('time') || userMessage.toLowerCase().includes('время')) {
                return lang === 'en' ? 
                    `The current time is ${new Date().toLocaleTimeString()}.` : 
                    `Текущее время: ${new Date().toLocaleTimeString()}.`;
            } else {
                return lang === 'en' ? 
                    "I understand you're asking about: " + userMessage + ". For more specific information, please provide additional details." : 
                    "Я понял, что вы спрашиваете о: " + userMessage + ". Для более конкретной информации, пожалуйста, уточните детали.";
            }
        }

        // Рендер Markdown/код-блоков: авто Markdown, JSON/код с подсветкой и кнопкой Copy
        function renderRichContent(text) {
            try {
                // если это потенциально markdown, парсим marked
                const md = window.marked ? marked.parse(text) : escapeHtml(text);
                // оборачиваем pre>code для кнопки копирования
                const temp = document.createElement('div');
                temp.innerHTML = md;
                temp.querySelectorAll('pre').forEach(pre => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.textContent = 'Copy';
                    copyBtn.onclick = () => {
                        const codeEl = pre.querySelector('code') || pre;
                        navigator.clipboard.writeText(codeEl.innerText || codeEl.textContent || '')
                            .then(()=>{ copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); });
                    };
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(copyBtn);
                    wrapper.appendChild(pre);
                });
                return temp.innerHTML;
            } catch (e) {
                return `<div>${escapeHtml(text)}</div>`;
            }
        }
        
        async function rateResponse(messageId, isPositive) {
            if (isPositive) {
                try {
                    await fetch(API_BASE + '/api/chat/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify({ message_id: Number(messageId.split('-').pop()), feedback: 1 })
                    });
                } catch {}
            } else {
                const messageDiv = document.getElementById(messageId);
                messageDiv.innerHTML += `
                    <div class="mt-3 p-3 bg-gray-100 rounded-lg">
                        <textarea class="w-full p-2 border border-gray-300 rounded mb-2" placeholder="${isEnglish ? uiTexts.en.feedbackPlaceholder : uiTexts.ru.feedbackPlaceholder}"></textarea>
                        <div class="flex justify-end gap-2">
                            <button onclick="cancelFeedback('${messageId}')" class="px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-200">
                                ${isEnglish ? uiTexts.en.cancelFeedback : uiTexts.ru.cancelFeedback}
                            </button>
                            <button onclick="submitFeedback('${messageId}')" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                ${isEnglish ? uiTexts.en.submitFeedback : uiTexts.ru.submitFeedback}
                            </button>
                        </div>
                    </div>
                `;
                feather.replace();
            }
        }
        
        function cancelFeedback(messageId) {
            const messageDiv = document.getElementById(messageId);
            const bubble = messageDiv.querySelector('.chat-bubble-ai');
            bubble.innerHTML = bubble.innerHTML.split('<div class="mt-3 p-3 bg-gray-100 rounded-lg">')[0];
            feather.replace();
        }
        
        async function submitFeedback(messageId) {
            const messageDiv = document.getElementById(messageId);
            const textarea = messageDiv.querySelector('textarea');
            const feedback = textarea.value.trim();
            
            if (feedback) {
                try {
                    await fetch(API_BASE + '/api/chat/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify({ message_id: Number(messageId.split('-').pop()), feedback: -1, comment: feedback })
                    });
                } catch {}
                alert(isEnglish ? 'Thank you for your feedback!' : 'Спасибо за ваш отзыв!');
            }
            cancelFeedback(messageId);
        }
        
        // Admin panel functions
        function showAdminPanel() {
            if (!isAdmin()) {
                alert(isEnglish ? 'Admin privileges required' : 'Требуются права администратора');
                return;
            }
            document.getElementById('adminPanel').classList.remove('hidden');
            loadArticlesTable();
        }
        
        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }
        
        async function loadArticlesTable() {
            const tbody = document.getElementById('articlesTableBody');
            tbody.innerHTML = '';
            try {
                const all = await fetchAllArticles();
                all.forEach(article => {
                    const row = document.createElement('tr');
                    const cats = (article.categories || []).map(c => c.name);
                    const tags = (article.tags || []).map(t => t.name);
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${article.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${(article.title||'').slice(0,100)}${(article.title||'').length>100?'…':''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cats.join(', ')}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-wrap gap-1">
                                ${tags.map(tag => `<span class=\"px-2 py-1 text-xs rounded-full bg-gray-100\">${tag}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${article.updated_at || ''}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="editArticle(${article.id})">Edit</button>
                            <button class="text-purple-600 hover:text-purple-900 mr-3" onclick="generateMeta(${article.id})">Generate</button>
                            <button onclick="deleteArticle(${article.id})" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                feather.replace();
            } catch (e) {
                tbody.innerHTML = '<tr><td class="px-6 py-4 text-red-600">Failed to load articles</td></tr>';
            }
            setupAdminStickyHeaderAndScroll();
        }

        async function fetchAllArticles() {
            const headers = { ...authHeader() };
            const pageSize = 200;
            let skip = 0;
            const out = [];
            while (true) {
                const url = `${API_BASE}/api/admin/articles?skip=${skip}&limit=${pageSize}`;
                const res = await fetch(url, { headers });
                if (!res.ok) break;
                const data = await res.json();
                const chunk = data.articles || [];
                out.push(...chunk);
                if (chunk.length < pageSize) break;
                skip += pageSize;
            }
            return out;
        }

        // Закрепленные шапки и снизу — зеркало горизонтального скролла
        function setupAdminStickyHeaderAndScroll(){
            const container = document.getElementById('articlesContainer');
            const table = document.getElementById('articlesTable');
            const adminSection = document.getElementById('adminSection');
            const headerClone = document.getElementById('adminHeaderClone');
            const headerScroller = document.getElementById('adminHeaderScroller');
            const mirror = document.getElementById('adminScrollMirror');
            const spacer = document.getElementById('adminScrollSpacer');
            if (!container || !table || !mirror || !spacer || !headerClone || !headerScroller || !adminSection) return;

            // Показать зеркало только если таблица шире контейнера
            const needsScroll = table.scrollWidth > container.clientWidth;
            mirror.classList.toggle('hidden', !needsScroll);
            spacer.style.width = table.scrollWidth + 'px';

            // Клонируем thead для фиксированной шапки
            const thead = table.querySelector('thead');
            if (thead) {
                const cloneTable = document.createElement('table');
                cloneTable.className = table.className;
                const clonedHead = thead.cloneNode(true);
                cloneTable.appendChild(clonedHead);
                headerScroller.innerHTML = '';
                headerScroller.appendChild(cloneTable);
                // ширина клон-таблицы = ширина оригинала
                cloneTable.style.width = table.scrollWidth + 'px';
                headerScroller.style.width = container.clientWidth + 'px';
            }

            // Синхронизация скроллов
            let syncing = false;
            container.addEventListener('scroll', () => {
                if (syncing) return; syncing = true;
                mirror.scrollLeft = container.scrollLeft; syncing = false;
                // keep sticky header scroller aligned
                if (headerScroller) headerScroller.scrollLeft = container.scrollLeft;
                onScroll();
            });
            mirror.addEventListener('scroll', () => {
                if (syncing) return; syncing = true;
                container.scrollLeft = mirror.scrollLeft; syncing = false;
                if (headerScroller) headerScroller.scrollLeft = mirror.scrollLeft;
            });

            // Отображение/позиционирование фиксированной шапки и зеркала
            function onScroll(){
                if (!container || !adminSection) return;
                const rect = container.getBoundingClientRect();
                const sectionRect = adminSection.getBoundingClientRect();
                const viewportH = window.innerHeight || document.documentElement.clientHeight;

                // Показ только при необходимости
                if (!needsScroll) { mirror.style.display = 'none'; headerClone.style.display = 'none'; return; }

                // Фиксированная шапка: показывать при вертикальной прокрутке контейнера
                const showHeader = container.scrollTop > 0 && container.scrollTop < (container.scrollHeight - container.clientHeight);
                if (showHeader) {
                    headerClone.style.display = 'block';
                    // выравнивание ширин колонок
                    try {
                        const origCells = Array.from((table.querySelector('thead tr') || table.querySelector('tr')).children);
                        const cloneCells = Array.from((headerScroller.querySelector('thead tr') || headerScroller.querySelector('tr')).children);
                        const widths = origCells.map(td => td.getBoundingClientRect().width);
                        cloneCells.forEach((td, i) => { td.style.width = (widths[i] || 0) + 'px'; });
                        // позиция и ширина (привязка к контейнеру с таблицей)
                        headerClone.style.left = sectionRect.left + 'px';
                        headerClone.style.right = (window.innerWidth - sectionRect.right) + 'px';
                        headerClone.style.top = '0px';
                        headerScroller.style.width = container.clientWidth + 'px';
                        const cloneTableEl = headerScroller.querySelector('table');
                        if (cloneTableEl) cloneTableEl.style.width = table.scrollWidth + 'px';
                        if (headerScroller) headerScroller.scrollLeft = container.scrollLeft;
                    } catch {}
                } else {
                    headerClone.style.display = 'none';
                }

                // Когда низ таблицы достиг низа окна, докуем зеркало к низу таблицы (absolute внутри секции)
                const mirrorH = mirror.offsetHeight || 12;
                const shouldDock = rect.bottom <= viewportH;
                if (shouldDock) {
                    mirror.style.position = 'absolute';
                    mirror.style.left = sectionRect.left + 'px';
                    mirror.style.right = (window.innerWidth - sectionRect.right) + 'px';
                    const bottomOffset = Math.max(0, sectionRect.bottom - viewportH);
                    mirror.style.bottom = bottomOffset + 'px';
                    mirror.style.display = 'block';
                } else {
                    // Иначе держим у низа вьюпорта (fixed)
                    mirror.style.position = 'fixed';
                    mirror.style.left = '0px';
                    mirror.style.right = '0px';
                    mirror.style.bottom = '0px';
                    mirror.style.display = (rect.top < viewportH && rect.bottom > 0) ? 'block' : 'none';
                }
            }
            window.addEventListener('scroll', onScroll);
            window.addEventListener('resize', () => { setupAdminStickyHeaderAndScroll(); });
            onScroll();
        }
        
        let currentEditId = null;

        async function loadCategoriesIntoSelect() {
            const select = document.getElementById('articleCategory');
            select.innerHTML = '<option value="">Select a category</option>';
            try {
                const res = await fetch(API_BASE + '/api/admin/categories', { headers: { ...authHeader() } });
                const cats = await res.json();
                cats.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = String(cat.id);
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (e) {
                // fallback пустой список
            }
        }

        async function showCreateArticleModal() {
            currentEditId = null;
            document.getElementById('createArticleModal').classList.remove('hidden');
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('tagsContainer').innerHTML = '';
            await loadCategoriesIntoSelect();
        }
        
        function hideCreateArticleModal() {
            document.getElementById('createArticleModal').classList.add('hidden');
            document.getElementById('articleTitle').value = '';
            document.getElementById('articleContent').value = '';
            document.getElementById('tagsContainer').innerHTML = '';
            document.getElementById('newTagInput').value = '';
        }
        
        function addTag() {
            const input = document.getElementById('newTagInput');
            const tag = input.value.trim();
            
            if (tag) {
                const container = document.getElementById('tagsContainer');
                container.innerHTML += `
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1">
                        ${tag}
                        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    </span>
                `;
                input.value = '';
                feather.replace();
            }
        }
        
        async function saveArticle() {
            const title = document.getElementById('articleTitle').value.trim();
            const categoryId = document.getElementById('articleCategory').value;
            const content = document.getElementById('articleContent').value.trim();
            const tagSpans = Array.from(document.querySelectorAll('#tagsContainer span'));
            const tag_names = tagSpans.map(s => s.firstChild?.textContent?.trim()).filter(Boolean);

            if (!title || !content) {
                alert(isEnglish ? "Please fill required fields" : "Пожалуйста, заполните обязательные поля");
                return;
            }

            const payload = {
                title,
                text: content,
                url: '',
                language: isEnglish ? 'en' : 'ru',
                category_ids: categoryId ? [Number(categoryId)] : [],
                tag_names
            };

            try {
                if (currentEditId) {
                    await fetch(API_BASE + `/api/admin/articles/${currentEditId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify(payload)
                    });
                } else {
                    await fetch(API_BASE + '/api/admin/articles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', ...authHeader() },
                        body: JSON.stringify(payload)
                    });
                }
                hideCreateArticleModal();
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Save failed' : 'Ошибка сохранения');
            }
        }
        
        async function editArticle(id) {
            try {
                const res = await fetch(API_BASE + `/api/admin/articles/${id}`, { headers: { ...authHeader() } });
                const article = await res.json();
                currentEditId = id;
                document.getElementById('createArticleModal').classList.remove('hidden');
                document.getElementById('articleTitle').value = article.title || '';
                document.getElementById('articleContent').value = article.text || '';
                document.getElementById('tagsContainer').innerHTML = '';
                (article.tags || []).forEach(t => {
                    const span = document.createElement('span');
                    span.className = 'px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1';
                    span.innerHTML = `${t.name}<button onclick=\"this.parentElement.remove()\" class=\"text-gray-500 hover:text-gray-700\"><i data-feather=\"x\" class=\"w-3 h-3\"></i></button>`;
                    document.getElementById('tagsContainer').appendChild(span);
                });
                await loadCategoriesIntoSelect();
                const select = document.getElementById('articleCategory');
                const firstCat = (article.categories || [])[0];
                if (firstCat) select.value = String(firstCat.id);
                feather.replace();
            } catch (e) {
                alert(isEnglish ? 'Failed to load article' : 'Ошибка загрузки статьи');
            }
        }
        
        async function deleteArticle(id) {
            if (!confirm(isEnglish ? `Delete article ${id}?` : `Удалить статью ${id}?`)) return;
            try {
                await fetch(API_BASE + `/api/admin/articles/${id}`, { method: 'DELETE', headers: { ...authHeader() } });
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Delete failed' : 'Ошибка удаления');
            }
        }
        
        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
        }
        
        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }
        
        
        async function reindex() {
            try {
                await fetch(API_BASE + '/api/admin/reindex', { method: 'POST', headers: { ...authHeader() } });
                alert(isEnglish ? 'Reindex finished' : 'Переиндексация завершена');
            } catch (e) {
                alert(isEnglish ? 'Reindex failed' : 'Ошибка переиндексации');
            }
        }

        async function generateMeta(id) {
            try {
                const res = await fetch(API_BASE + `/api/admin/articles/${id}/generate_meta`, { method: 'POST', headers: { ...authHeader() } });
                if (!res.ok) throw new Error('failed');
                const data = await res.json();
                alert((isEnglish ? 'Updated: ' : 'Обновлено: ') + `Tags: ${data.tags.join(', ')}; Category: ${(data.categories||[]).join(', ')}`);
                loadArticlesTable();
            } catch (e) {
                alert(isEnglish ? 'Generation failed' : 'Ошибка генерации');
            }
        }

        async function generateMetaSelected() {
            // Генерация для всех статей
            const btn = Array.from(document.querySelectorAll('button')).find(b => b.textContent && b.textContent.includes('Generate Tags & Category'));
            if (btn) { btn.disabled = true; btn.classList.add('opacity-60','cursor-not-allowed'); }
            const ids = Array.from(document.querySelectorAll('#articlesTableBody tr td:first-child')).map(td => Number(td.textContent));
            let processed = 0;
            for (const id of ids) {
                try { await generateMeta(id); } catch {}
                processed++;
                if (btn) btn.textContent = `Generating... ${processed}/${ids.length}`;
            }
            if (btn) { btn.disabled = false; btn.classList.remove('opacity-60','cursor-not-allowed'); btn.textContent = 'Generate Tags & Category'; }
            loadArticlesTable();
        }
        
        // Handle Enter key in message input
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // История
        async function loadHistory(sessionId) {
            try {
                const url = new URL(API_BASE + '/api/chat/history');
                url.searchParams.set('user_id', 'web-user');
                if (sessionId) url.searchParams.set('session_id', String(sessionId));
                const res = await fetch(url, { headers: { ...authHeader() } });
                const data = await res.json();
                const chat = document.getElementById('chatArea');
                if (!chat) return;
                chat.innerHTML = '';
                (data.history || []).forEach(item => {
                    addUserMessage(escapeHtml(item.q || ''));
                    addAIMessage(escapeHtml(item.a || ''));
                });
                renderSessionSelector(data.sessions || [], data.current_session);
            } catch {}
        }

        async function newChat() {
            try {
                const res = await fetch(API_BASE + '/api/chat/new_chat?user_id=web-user', { method: 'POST', headers: { ...authHeader() } });
                const data = await res.json();
                loadHistory(data.session_id);
                const chat = document.getElementById('chatArea');
                if (chat) chat.innerHTML = `
                    <div class="text-center py-8 text-gray-500" id="emptyState">
                        <i data-feather="message-square" class="w-12 h-12 mx_auto text-gray-300"></i>
                        <p class="mt-4">${isEnglish ? uiTexts.en.welcomeMessage : uiTexts.ru.welcomeMessage}</p>
                    </div>
                `;
            } catch {}
        }

        function newChatUI() { newChat(); }

        function renderSessionSelector(sessions, current) {
            const historyContainer = document.getElementById('chatHistory');
            if (!historyContainer) return;
            
            if (sessions.length === 0) {
                historyContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i data-feather="message-square" class="w-8 h-8 mx-auto text-gray-300"></i>
                        <p class="mt-2 text-sm">No chat history</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            historyContainer.innerHTML = `
                <div class="space-y-2">
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">Recent Chats</div>
                    ${sessions.map(id => {
                        const active = (id === current);
                        return `
                            <button onclick="loadHistory(${id})" class="w-full text-left p-3 rounded-lg border transition-colors ${active ? 'bg-blue-50 border-blue-200 text-blue-700' : 'bg-white border-gray-200 hover:bg-gray-50'}">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium">Chat #${id}</span>
                                    ${active ? '<i data-feather="check" class="w-4 h-4 text-blue-600"></i>' : ''}
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
            feather.replace();
        }


        // Функции для работы с документами
        function showArticlesTab() {
            document.getElementById('articlesSection').classList.remove('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('articlesTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('articlesTab').classList.remove('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
        }

        function showDocumentsTab() {
            document.getElementById('articlesSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.remove('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('documentsTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.remove('text-gray-500');
            document.getElementById('articlesTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('articlesTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            loadDocumentsTable();
        }

        function showAiTab() {
            document.getElementById('articlesSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.remove('hidden');
            document.getElementById('usersSection').classList.add('hidden');
            document.getElementById('aiTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.remove('text-gray-500');
            document.getElementById('articlesTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('articlesTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('usersTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.add('text-gray-500');
            loadAiSettings();
        }

        function showUsersTab() {
            document.getElementById('articlesSection').classList.add('hidden');
            document.getElementById('documentsSection').classList.add('hidden');
            document.getElementById('aiSection').classList.add('hidden');
            document.getElementById('usersSection').classList.remove('hidden');
            document.getElementById('usersTab').classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('usersTab').classList.remove('text-gray-500');
            document.getElementById('articlesTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('articlesTab').classList.add('text-gray-500');
            document.getElementById('documentsTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('documentsTab').classList.add('text-gray-500');
            document.getElementById('aiTab').classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
            document.getElementById('aiTab').classList.add('text-gray-500');
            loadUsersTable();
        }

        // Функции для работы с пользователями
        async function loadUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            try {
                const res = await fetch(API_BASE + '/api/auth/users', { 
                    headers: { ...authHeader() } 
                });
                
                if (!res.ok) {
                    throw new Error('Failed to load users');
                }
                
                const users = await res.json();
                
                users.forEach(user => {
                    const row = document.createElement('tr');
                    const statusColor = user.is_active ? 'text-green-600' : 'text-red-600';
                    const statusText = user.is_active ? 'Активен' : 'Неактивен';
                    const roleColor = user.role === 'admin' ? 'text-red-600' : 'text-blue-600';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.full_name || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${roleColor} font-medium">${user.role}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${statusText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(user.created_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="editUser(${user.id})" class="text-blue-600 hover:text-blue-900 mr-3">Изменить</button>
                            ${user.id !== currentUser?.id ? `<button onclick="deleteUser(${user.id})" class="text-red-600 hover:text-red-900">Удалить</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
            } catch (e) {
                console.error('Ошибка загрузки пользователей:', e);
                tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Ошибка загрузки пользователей</td></tr>';
            }
        }

        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
            document.getElementById('userEmail').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
        }

        function hideCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
        }

        async function createUser() {
            const email = document.getElementById('userEmail').value;
            const fullName = document.getElementById('userFullName').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            if (!email || !password) {
                alert('Пожалуйста, заполните email и пароль');
                return;
            }
            
            if (password.length < 6) {
                alert('Пароль должен содержать минимум 6 символов');
                return;
            }
            
            try {
                const userData = {
                    email: email,
                    full_name: fullName,
                    password: password,
                    role: role
                };
                
                const res = await fetch(API_BASE + '/api/auth/users', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        ...authHeader() 
                    },
                    body: JSON.stringify(userData)
                });
                
                if (res.ok) {
                    alert('Пользователь успешно создан');
                    hideCreateUserModal();
                    loadUsersTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка создания пользователя: ${error.detail}`);
                }
                
            } catch (e) {
                console.error('Ошибка создания пользователя:', e);
                alert('Ошибка создания пользователя');
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                return;
            }
            
            try {
                const res = await fetch(API_BASE + `/api/auth/users/${userId}`, {
                    method: 'DELETE',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Пользователь успешно удален');
                    loadUsersTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка удаления пользователя: ${error.detail}`);
                }
                
            } catch (e) {
                console.error('Ошибка удаления пользователя:', e);
                alert('Ошибка удаления пользователя');
            }
        }

        function editUser(userId) {
            // Пока простое сообщение, можно расширить до полноценного редактирования
            alert('Функция редактирования пользователя будет добавлена в следующей версии');
        }

        function showUploadDocumentModal() {
            document.getElementById('uploadDocumentModal').classList.remove('hidden');
            document.getElementById('documentFile').value = '';
            document.getElementById('documentTagsContainer').innerHTML = '';
            loadCategoriesIntoDocumentSelect();
        }

        function hideUploadDocumentModal() {
            document.getElementById('uploadDocumentModal').classList.add('hidden');
            document.getElementById('documentFile').value = '';
            document.getElementById('documentPath').value = '';
            document.getElementById('documentTagsContainer').innerHTML = '';
        }

        async function loadDocumentsTable() {
            const tbody = document.getElementById('documentsTableBody');
            tbody.innerHTML = '';
            try {
                const res = await fetch(API_BASE + '/api/documents/', { headers: { ...authHeader() } });
                const data = await res.json();
                data.documents.forEach(doc => {
                    const row = document.createElement('tr');
                    const tags = (doc.tags || []).map(t => t.name);
                    const statusColor = {
                        'completed': 'text-green-600',
                        'processing': 'text-yellow-600',
                        'failed': 'text-red-600',
                        'pending': 'text-gray-600'
                    }[doc.processing_status] || 'text-gray-600';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="document-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${doc.id}" onchange="updateSelectAllCheckbox()">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${doc.original_filename}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.topic || 'Не определена'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.path || 'Не указан'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm ${statusColor}">${doc.processing_status}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-wrap gap-1">
                                ${tags.map(tag => `<span class="px-2 py-1 text-xs rounded-full bg-gray-100">${tag}</span>`).join('')}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(doc.uploaded_at).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewDocument(${doc.id})">Просмотр</button>
                            <button class="text-yellow-600 hover:text-yellow-900 mr-3" onclick="editDocument(${doc.id})">Редактировать</button>
                            <button class="text-green-600 hover:text-green-900 mr-3" onclick="processDocument(${doc.id})">Обработать</button>
                            <button class="text-cyan-600 hover:text-cyan-900 mr-3" onclick="viewChunks(${doc.id})">Чанки</button>
                            <button class="text-orange-600 hover:text-orange-900 mr-3" onclick="generateCategories(${doc.id})">Категории</button>
                            <button class="text-indigo-600 hover:text-indigo-900 mr-3" onclick="generateTags(${doc.id})">Теги</button>
                            <button class="text-teal-600 hover:text-teal-900 mr-3" onclick="generateAllMeta(${doc.id})">Все метаданные</button>
                            <button class="text-purple-600 hover:text-purple-900 mr-3" onclick="downloadDocument(${doc.id})">Скачать</button>
                            <button onclick="deleteDocument(${doc.id})" class="text-red-600 hover:text-red-900">Удалить</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                feather.replace();
            } catch (e) {
                tbody.innerHTML = '<tr><td class="px-6 py-4 text-red-600">Ошибка загрузки документов</td></tr>';
            }
        }

        async function loadCategoriesIntoDocumentSelect() {
            const select = document.getElementById('documentCategory');
            select.innerHTML = '<option value="">Выберите категорию</option>';
            try {
                const res = await fetch(API_BASE + '/api/admin/categories', { headers: { ...authHeader() } });
                const cats = await res.json();
                cats.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = String(cat.id);
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('Ошибка загрузки категорий:', e);
            }
        }

        function addDocumentTag() {
            const input = document.getElementById('newDocumentTagInput');
            const tag = input.value.trim();
            
            if (tag) {
                const container = document.getElementById('documentTagsContainer');
                container.innerHTML += `
                    <span class="px-2 py-1 text-xs rounded-full bg-gray-100 flex items-center gap-1">
                        ${tag}
                        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
                            <i data-feather="x" class="w-3 h-3"></i>
                        </button>
                    </span>
                `;
                input.value = '';
                feather.replace();
            }
        }

        async function uploadDocument() {
            const fileInput = document.getElementById('documentFile');
            const language = document.getElementById('documentLanguage').value;
            const path = document.getElementById('documentPath').value;
            const categoryId = document.getElementById('documentCategory').value;
            const tagSpans = Array.from(document.querySelectorAll('#documentTagsContainer span'));
            const tagNames = tagSpans.map(s => s.firstChild?.textContent?.trim()).filter(Boolean);

            if (!fileInput.files.length) {
                alert('Пожалуйста, выберите файл');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('language', language);
            if (path) {
                formData.append('path', path);
            }
            formData.append('category_ids', JSON.stringify(categoryId ? [Number(categoryId)] : []));
            formData.append('tag_names', JSON.stringify(tagNames));

            try {
                console.log('Отправка запроса на загрузку документа...');
                const res = await fetch(API_BASE + '/api/documents/upload', {
                    method: 'POST',
                    headers: { ...authHeader() },
                    body: formData
                });
                
                console.log('Ответ сервера:', res.status, res.statusText);
                
                if (res.ok) {
                    const data = await res.json();
                    console.log('Данные ответа:', data);
                    alert(`Документ загружен! ID: ${data.document_id}, Статус: ${data.processing_status}`);
                    hideUploadDocumentModal();
                    loadDocumentsTable();
                } else {
                    const error = await res.json();
                    console.error('Ошибка сервера:', error);
                    alert(`Ошибка загрузки: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка при загрузке документа:', e);
                alert('Ошибка при загрузке документа');
            }
        }

        async function viewDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/text`, { headers: { ...authHeader() } });
                const data = await res.json();
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-8 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Просмотр документа</h3>
                            <button onclick="this.closest('.fixed').remove()" class="p-2 rounded-full hover:bg-gray-100">
                                <i data-feather="x"></i>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div><strong>Заголовок:</strong> ${data.title || 'Не указан'}</div>
                            <div><strong>Тема:</strong> ${data.topic || 'Не определена'}</div>
                            ${data.path ? `<div><strong>Путь:</strong> <span class="text-blue-600">${data.path}</span></div>` : ''}
                            <div><strong>Статус:</strong> ${data.processing_status}</div>
                            <div><strong>Краткое содержание:</strong></div>
                            <div class="p-3 bg-gray-100 rounded">${data.summary || 'Не создано'}</div>
                            <div><strong>Полный текст:</strong></div>
                            <div class="p-3 bg-gray-50 rounded max-h-96 overflow-y-auto">${data.extracted_text || 'Не извлечен'}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                feather.replace();
            } catch (e) {
                alert('Ошибка при загрузке документа');
            }
        }

        async function processDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/process`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Обработка документа запущена');
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при запуске обработки');
                }
            } catch (e) {
                alert('Ошибка при обработке документа');
            }
        }

        async function generateCategories(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-categories`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации категорий');
                }
            } catch (e) {
                alert('Ошибка при генерации категорий');
            }
        }

        async function generateTags(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-tags`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации тегов');
                }
            } catch (e) {
                alert('Ошибка при генерации тегов');
            }
        }

        async function generateAllMeta(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/generate-meta`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        alert(`✅ ${data.message}`);
                        loadDocumentsTable();
                    } else {
                        alert(`❌ ${data.message}`);
                    }
                } else {
                    alert('Ошибка при генерации метаданных');
                }
            } catch (e) {
                alert('Ошибка при генерации метаданных');
            }
        }

        async function downloadDocument(id) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}/download`, { headers: { ...authHeader() } });
                if (res.ok) {
                    const blob = await res.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `document_${id}`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Ошибка при скачивании документа');
                }
            } catch (e) {
                alert('Ошибка при скачивании документа');
            }
        }

        async function deleteDocument(id) {
            if (!confirm(`Удалить документ ${id}?`)) return;
            try {
                const res = await fetch(API_BASE + `/api/documents/${id}`, {
                    method: 'DELETE',
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    alert('Документ удален');
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при удалении документа');
                }
            } catch (e) {
                alert('Ошибка при удалении документа');
            }
        }

        async function processAllDocuments() {
            if (!confirm('Обработать все документы? Это может занять некоторое время.')) return;
            
            try {
                // Получаем все документы
                const res = await fetch(API_BASE + '/api/documents/', { headers: { ...authHeader() } });
                const data = await res.json();
                const documentIds = data.documents.map(d => d.id);
                
                if (documentIds.length === 0) {
                    alert('Нет документов для обработки');
                    return;
                }
                
                // Запускаем пакетную обработку
                const batchRes = await fetch(API_BASE + '/api/documents/batch-process', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify(documentIds)
                });
                
                if (batchRes.ok) {
                    const result = await batchRes.json();
                    alert(`Обработка завершена. Результаты: ${result.results.length} документов`);
                    loadDocumentsTable();
                } else {
                    alert('Ошибка при пакетной обработке');
                }
            } catch (e) {
                alert('Ошибка при пакетной обработке документов');
            }
        }

        // Функции для работы с чекбоксами и массовыми операциями
        function toggleAllDocuments() {
            const selectAll = document.getElementById('selectAllDocuments');
            const checkboxes = document.querySelectorAll('.document-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        function updateSelectAllCheckbox() {
            const selectAll = document.getElementById('selectAllDocuments');
            const checkboxes = document.querySelectorAll('.document-checkbox');
            const checkedCount = document.querySelectorAll('.document-checkbox:checked').length;
            
            if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        function getSelectedDocumentIds() {
            const checkboxes = document.querySelectorAll('.document-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.value));
        }

        async function generateCategoriesForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации категорий');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-categories`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Категории сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации категорий');
            }
        }

        async function generateTagsForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации тегов');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-tags`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Теги сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации тегов');
            }
        }

        async function generateAllMetaForSelected() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для генерации метаданных');
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}/generate-meta`, {
                        method: 'POST',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Метаданные сгенерированы для ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при генерации метаданных');
            }
        }

        async function deleteSelectedDocuments() {
            const selectedIds = getSelectedDocumentIds();
            if (selectedIds.length === 0) {
                alert('Выберите документы для удаления');
                return;
            }

            if (!confirm(`Вы уверены, что хотите удалить ${selectedIds.length} документов?`)) {
                return;
            }

            try {
                let successCount = 0;
                for (const id of selectedIds) {
                    const res = await fetch(API_BASE + `/api/documents/${id}`, {
                        method: 'DELETE',
                        headers: { ...authHeader() }
                    });
                    if (res.ok) {
                        successCount++;
                    }
                }
                alert(`✅ Удалено ${successCount} из ${selectedIds.length} документов`);
                loadDocumentsTable();
            } catch (e) {
                alert('Ошибка при удалении документов');
            }
        }

        async function viewChunks(documentId) {
            try {
                const res = await fetch(API_BASE + `/api/chunks/document/${documentId}`, {
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    showChunksModal(data.chunks, documentId);
                } else {
                    alert('Ошибка при загрузке чанков');
                }
            } catch (e) {
                alert('Ошибка при загрузке чанков');
            }
        }

        function showChunksModal(chunks, documentId) {
            const modal = document.getElementById('chunksModal');
            const chunksList = document.getElementById('chunksList');
            
            chunksList.innerHTML = '';
            
            chunks.forEach((chunk, index) => {
                const chunkDiv = document.createElement('div');
                chunkDiv.className = 'border rounded-lg p-4 mb-4 bg-gray-50';
                chunkDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-gray-800">Чанк ${chunk.chunk_index + 1}</h4>
                        <span class="text-sm text-gray-500">${chunk.text.length} символов</span>
                    </div>
                    <div class="text-sm text-gray-700 mb-2">
                        ${chunk.text.substring(0, 200)}${chunk.text.length > 200 ? '...' : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="viewFullChunk(${chunk.id})" class="text-blue-600 hover:text-blue-900 text-sm">Полный текст</button>
                        ${chunk.embedding ? '<span class="text-green-600 text-sm">✓ Эмбеддинг</span>' : '<span class="text-red-600 text-sm">✗ Нет эмбеддинга</span>'}
                    </div>
                `;
                chunksList.appendChild(chunkDiv);
            });
            
            modal.classList.remove('hidden');
        }

        function hideChunksModal() {
            document.getElementById('chunksModal').classList.add('hidden');
        }

        async function viewFullChunk(chunkId) {
            // Здесь можно добавить функцию для просмотра полного текста чанка
            alert('Функция просмотра полного текста чанка будет добавлена');
        }

        let currentEditingDocumentId = null;

        async function editDocument(documentId) {
            try {
                const res = await fetch(API_BASE + `/api/documents/${documentId}`, {
                    headers: { ...authHeader() }
                });
                
                if (res.ok) {
                    const doc = await res.json();
                    currentEditingDocumentId = documentId;
                    
                    // Заполняем форму данными документа
                    document.getElementById('editDocumentTitle').value = doc.title || '';
                    document.getElementById('editDocumentTopic').value = doc.topic || '';
                    document.getElementById('editDocumentPath').value = doc.path || '';
                    document.getElementById('editDocumentSummary').value = doc.summary || '';
                    
                    // Показываем модальное окно
                    document.getElementById('editDocumentModal').classList.remove('hidden');
                } else {
                    alert('Ошибка при загрузке документа');
                }
            } catch (e) {
                alert('Ошибка при загрузке документа');
            }
        }

        function hideEditDocumentModal() {
            document.getElementById('editDocumentModal').classList.add('hidden');
            currentEditingDocumentId = null;
        }

        async function saveDocumentChanges() {
            if (!currentEditingDocumentId) {
                alert('Ошибка: не выбран документ для редактирования');
                return;
            }

            const title = document.getElementById('editDocumentTitle').value;
            const topic = document.getElementById('editDocumentTopic').value;
            const path = document.getElementById('editDocumentPath').value;
            const summary = document.getElementById('editDocumentSummary').value;

            try {
                const res = await fetch(API_BASE + `/api/documents/${currentEditingDocumentId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        title: title,
                        topic: topic,
                        path: path,
                        summary: summary
                    })
                });

                if (res.ok) {
                    alert('✅ Документ успешно обновлен!');
                    hideEditDocumentModal();
                    loadDocumentsTable();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при сохранении: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при сохранении документа');
            }
        }

        // Переменные для импорта
        let importData = null;
        let importPreview = null;

        function showImportModal() {
            document.getElementById('importModal').classList.remove('hidden');
            showImportStep1();
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
            importData = null;
            importPreview = null;
        }

        function showImportStep1() {
            document.getElementById('importStep1').classList.remove('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importStep3').classList.add('hidden');
        }

        function showImportStep2() {
            document.getElementById('importStep1').classList.add('hidden');
            document.getElementById('importStep2').classList.remove('hidden');
            document.getElementById('importStep3').classList.add('hidden');
        }

        function showImportStep3() {
            document.getElementById('importStep1').classList.add('hidden');
            document.getElementById('importStep2').classList.add('hidden');
            document.getElementById('importStep3').classList.remove('hidden');
        }

        async function analyzeImportFile() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput.files.length) {
                alert('Пожалуйста, выберите JSON файл');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                const res = await fetch(API_BASE + '/api/import/analyze', {
                    method: 'POST',
                    headers: { ...authHeader() },
                    body: formData
                });

                if (res.ok) {
                    importPreview = await res.json();
                    displayFieldMappings();
                    showImportStep2();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при анализе файла: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при анализе файла');
            }
        }

        function displayFieldMappings() {
            if (!importPreview) return;

            document.getElementById('importRecordCount').textContent = importPreview.total_records;
            
            const container = document.getElementById('fieldMappingContainer');
            container.innerHTML = '';

            // Обязательные поля
            const requiredFields = ['title', 'text', 'url'];
            
            requiredFields.forEach(field => {
                const mapping = importPreview.field_mappings.find(m => m.db_field === field);
                const div = document.createElement('div');
                div.className = 'space-y-2';
                
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">
                        ${field === 'title' ? 'Заголовок' : field === 'text' ? 'Текст' : 'URL'} 
                        ${requiredFields.includes(field) ? '*' : ''}
                    </label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                            data-db-field="${field}">
                        <option value="">-- Не сопоставлять --</option>
                        ${importPreview.available_fields.map(f => 
                            `<option value="${f}" ${mapping && mapping.json_field === f ? 'selected' : ''}>${f}</option>`
                        ).join('')}
                    </select>
                `;
                
                container.appendChild(div);
            });

            // Дополнительные поля
            const additionalFields = ['language'];
            additionalFields.forEach(field => {
                const mapping = importPreview.field_mappings.find(m => m.db_field === field);
                const div = document.createElement('div');
                div.className = 'space-y-2';
                
                div.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700">Язык</label>
                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                            data-db-field="${field}">
                        <option value="">-- Не сопоставлять (будет использован русский) --</option>
                        ${importPreview.available_fields.map(f => 
                            `<option value="${f}" ${mapping && mapping.json_field === f ? 'selected' : ''}>${f}</option>`
                        ).join('')}
                    </select>
                `;
                
                container.appendChild(div);
            });
        }

        async function startImport() {
            if (!importPreview) return;

            // Собираем сопоставления полей
            const fieldMappings = [];
            const selects = document.querySelectorAll('#fieldMappingContainer select[data-db-field]');
            
            selects.forEach(select => {
                const dbField = select.getAttribute('data-db-field');
                const jsonField = select.value;
                
                if (jsonField) {
                    fieldMappings.push({
                        json_field: jsonField,
                        db_field: dbField,
                        required: ['title', 'text', 'url'].includes(dbField)
                    });
                }
            });

            // Проверяем обязательные поля
            const requiredFields = ['title', 'text'];
            const mappedFields = fieldMappings.map(m => m.db_field);
            
            for (const field of requiredFields) {
                if (!mappedFields.includes(field)) {
                    alert(`Обязательное поле "${field}" должно быть сопоставлено`);
                    return;
                }
            }

            try {
                const res = await fetch(API_BASE + '/api/import/articles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify({
                        json_data: importPreview.sample_records, // Используем только примеры для тестирования
                        field_mappings: fieldMappings,
                        default_language: 'ru'
                    })
                });

                if (res.ok) {
                    const result = await res.json();
                    displayImportResults(result);
                    showImportStep3();
                } else {
                    const error = await res.json();
                    alert(`Ошибка при импорте: ${error.detail}`);
                }
            } catch (e) {
                alert('Ошибка при импорте');
            }
        }

        function displayImportResults(result) {
            const container = document.getElementById('importResults');
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center gap-4">
                        <div class="text-green-600">
                            <i data-feather="check-circle" class="w-6 h-6"></i>
                        </div>
                        <span class="text-lg font-semibold">Успешно импортировано: ${result.success_count}</span>
                    </div>
                    
                    ${result.error_count > 0 ? `
                        <div class="flex items-center gap-4">
                            <div class="text-red-600">
                                <i data-feather="x-circle" class="w-6 h-6"></i>
                            </div>
                            <span class="text-lg font-semibold">Ошибок: ${result.error_count}</span>
                        </div>
                        
                        <div class="bg-red-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-red-800 mb-2">Ошибки:</h4>
                            <ul class="text-sm text-red-700 space-y-1">
                                ${result.errors.map(error => `<li>• ${error}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <p class="text-sm text-blue-800">
                            Импортированные ID: ${result.imported_ids.join(', ')}
                        </p>
                    </div>
                </div>
            `;
            
            feather.replace();
        }

        // Initialize
        updateUILanguage();
        loadHistory();
        
        // Функция для восстановления мини-бара источников
        function restoreSourcesBar() {
            console.log('Attempting to restore sources bar...');
            try {
                // Проверяем, не существует ли уже мини-бар
                const chat = document.getElementById('chatArea');
                if (!chat) {
                    console.log('Chat area not found');
                    return;
                }
                
                const existingBar = chat.querySelector('[id^="refbar-"]');
                if (existingBar) {
                    console.log('Sources bar already exists, skipping restoration');
                    return;
                }
                
                // Проверяем, есть ли реальные сообщения в чате (не только приветствие)
                const messages = chat.querySelectorAll('.message');
                const userMessages = chat.querySelectorAll('.message.user');
                const aiMessages = chat.querySelectorAll('.message.ai');
                
                // Если есть только приветственное сообщение AI, не восстанавливаем мини-бар
                if (messages.length <= 1 && aiMessages.length === 1) {
                    console.log('Only welcome message found, clearing localStorage and skipping restoration');
                    // Очищаем localStorage если в чате только приветствие
                    localStorage.removeItem('lastSources');
                    localStorage.removeItem('lastSourcesCount');
                    localStorage.removeItem('lastSourcesIcons');
                    return;
                }
                
                // Если нет пользовательских сообщений, не восстанавливаем мини-бар
                if (userMessages.length === 0) {
                    console.log('No user messages found, skipping restoration');
                    return;
                }
                
                const lastSources = localStorage.getItem('lastSources');
                const lastSourcesCount = localStorage.getItem('lastSourcesCount');
                const lastSourcesIcons = localStorage.getItem('lastSourcesIcons');
                
                console.log('localStorage data:', { lastSources, lastSourcesCount, lastSourcesIcons });
                
                if (lastSources && lastSourcesCount && lastSourcesIcons) {
                    const sources = JSON.parse(lastSources);
                    const count = parseInt(lastSourcesCount);
                    const icons = JSON.parse(lastSourcesIcons);
                    
                    if (sources.length > 0) {
                        console.log('Restoring sources bar with data:', { sources, count, icons });
                        // Восстанавливаем данные в window
                        window.__lastSources = sources;
                        
                        // Создаем мини-бар
                        const chat = document.getElementById('chatArea');
                        if (chat) {
                            console.log('Creating sources bar in chat area');
                            const barId = 'refbar-' + Date.now();
                            chat.innerHTML += `
                                <div id="${barId}" class="flex items-center gap-2 text-xs text-gray-600 cursor-pointer select-none hover:text-blue-600 transition-colors p-2 rounded-lg hover:bg-blue-50" role="button" tabindex="0">
                                    <div class="flex items-center justify-center w-4 h-4">
                                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M0.300842 6.75896C0.300842 3.2391 3.15501 0.384938 6.67487 0.384938C6.98421 0.384956 7.28876 0.407574 7.58698 0.450368L7.49518 1.09392L7.4024 1.73748C7.16512 1.70342 6.92228 1.68574 6.67487 1.68572C3.87298 1.68572 1.60162 3.95707 1.60162 6.75896C1.60182 9.56068 3.8731 11.8322 6.67487 11.8322C9.0556 11.832 11.0549 10.1909 11.6006 7.97771L12.2315 8.13299L12.8624 8.28924C12.1767 11.0694 9.66758 13.1318 6.67487 13.132C3.15513 13.132 0.301038 10.2787 0.300842 6.75896Z" fill="currentColor"></path>
                                            <path d="M15.6992 14.8074L14.7793 15.7274L11.3974 12.3455L12.3174 11.4256L15.6992 14.8074Z" fill="currentColor"></path>
                                            <path d="M11.3473 6.59701C11.2764 6.81246 10.9716 6.81246 10.9008 6.59701L10.4901 5.34822C10.3035 4.78103 9.85867 4.33617 9.29148 4.14962L8.04269 3.73893C7.82724 3.66807 7.82724 3.36329 8.04269 3.29243L9.29148 2.88173C9.85867 2.69519 10.3035 2.25032 10.4901 1.68314L10.9008 0.434345C10.9716 0.218896 11.2764 0.218896 11.3473 0.434345L11.758 1.68314C11.9445 2.25032 12.3894 2.69519 12.9566 2.88173L14.2054 3.29243C14.4208 3.36329 14.4208 3.66807 14.2054 3.73893L12.9566 4.14962C12.3894 4.33617 11.9445 4.78103 11.758 5.34822L11.3473 6.59701Z" fill="currentColor"></path>
                                        </svg>
                                    </div>
                                    <span class="font-medium">${isEnglish ? 'Found' : 'Найдено'} ${count} ${isEnglish ? 'sources' : 'источников'}</span>
                                    <div class="flex items-center gap-1 ml-auto">${icons.join('')}</div>
                                </div>
                            `;
                            
                            // Добавляем обработчик клика
                            const barEl = document.getElementById(barId);
                            if (barEl) {
                                const handler = function(ev){
                                    ev.preventDefault();
                                    ev.stopPropagation();
                                    showSourcesUI();
                                };
                                barEl.addEventListener('click', handler);
                                barEl.addEventListener('keydown', function(ev){ 
                                    if (ev.key === 'Enter' || ev.key === ' ') { 
                                        handler(ev); 
                                    } 
                                });
                            }
                        }
                    } else {
                        console.log('No sources to restore');
                    }
                } else {
                    console.log('No localStorage data found');
                }
            } catch (e) {
                console.error('Error restoring sources bar:', e);
            }
        }

        // Функции для работы с AI настройками
        function loadAiSettings() {
            // Загружаем сохраненные настройки
            loadSavedApiKeys();
            loadSavedModelSettings();
            loadCurrentSettings();
            checkConnectionStatus();
        }

        function loadSavedApiKeys() {
            // Загружаем сохраненные API ключи из localStorage
            const savedKeys = localStorage.getItem('aiApiKeys');
            if (savedKeys) {
                const keys = JSON.parse(savedKeys);
                document.getElementById('apiService').value = keys.service || 'mistral';
                document.getElementById('apiKey').value = keys.key || '';
            }

            // Добавляем опции для внешних API в селекты моделей
            addExternalApiOptions();
        }

        function addExternalApiOptions() {
            const responseSelect = document.getElementById('responseModel');
            const embeddingSelect = document.getElementById('embeddingModel');
            
            // Очищаем существующие опции внешних API
            Array.from(responseSelect.options).forEach(option => {
                if (option.value.startsWith('mistral:') || option.value.startsWith('openai:') || option.value.startsWith('anthropic:')) {
                    option.remove();
                }
            });
            Array.from(embeddingSelect.options).forEach(option => {
                if (option.value.startsWith('mistral:') || option.value.startsWith('openai:') || option.value.startsWith('anthropic:')) {
                    option.remove();
                }
            });

            // Добавляем опции для внешних API
            const externalOptions = [
                { value: 'mistral:mistral-large-latest', text: 'Mistral: mistral-large-latest' },
                { value: 'mistral:mistral-medium-latest', text: 'Mistral: mistral-medium-latest' },
                { value: 'openai:gpt-4', text: 'OpenAI: GPT-4' },
                { value: 'openai:gpt-3.5-turbo', text: 'OpenAI: GPT-3.5 Turbo' },
                { value: 'anthropic:claude-3-opus', text: 'Anthropic: Claude 3 Opus' },
                { value: 'anthropic:claude-3-sonnet', text: 'Anthropic: Claude 3 Sonnet' }
            ];

            externalOptions.forEach(option => {
                const responseOption = document.createElement('option');
                responseOption.value = option.value;
                responseOption.textContent = option.text;
                responseSelect.appendChild(responseOption);

                const embeddingOption = document.createElement('option');
                embeddingOption.value = option.value;
                embeddingOption.textContent = option.text;
                embeddingSelect.appendChild(embeddingOption);
            });
        }

        function loadSavedModelSettings() {
            // Загружаем сохраненные настройки моделей
            const savedSettings = localStorage.getItem('aiModelSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                document.getElementById('responseModel').value = settings.responseModel || '';
                document.getElementById('embeddingModel').value = settings.embeddingModel || '';
            }
        }

        function saveApiKey() {
            const service = document.getElementById('apiService').value;
            const key = document.getElementById('apiKey').value;
            
            if (!key.trim()) {
                alert('Введите API ключ');
                return;
            }

            // Сохраняем в localStorage
            const keys = { service, key };
            localStorage.setItem('aiApiKeys', JSON.stringify(keys));
            
            alert('API ключ сохранен');
            updateConnectionStatus('api', 'saved');
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const icon = document.getElementById('apiKeyToggleIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-feather', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        async function testApiConnection() {
            const service = document.getElementById('apiService').value;
            const key = document.getElementById('apiKey').value;
            
            if (!key.trim()) {
                alert('Введите API ключ для тестирования');
                return;
            }

            try {
                updateConnectionStatus('api', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...authHeader() },
                    body: JSON.stringify({ service, key })
                });

                if (res.ok) {
                    updateConnectionStatus('api', 'connected');
                    alert('Подключение успешно!');
                } else {
                    updateConnectionStatus('api', 'error');
                    alert('Ошибка подключения');
                }
            } catch (e) {
                updateConnectionStatus('api', 'error');
                alert('Ошибка подключения');
            }
        }

        async function loadOllamaModels() {
            try {
                updateConnectionStatus('ollama', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/ollama/models', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    displayOllamaModels(data.models);
                    updateConnectionStatus('ollama', 'connected');
                } else {
                    updateConnectionStatus('ollama', 'error');
                    alert('Ошибка загрузки моделей Ollama');
                }
            } catch (e) {
                updateConnectionStatus('ollama', 'error');
                alert('Ошибка подключения к Ollama');
            }
        }

        function displayOllamaModels(models) {
            const container = document.getElementById('ollamaModelsList');
            container.innerHTML = '';

            if (models.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Модели не найдены</p>';
                return;
            }

            // Заполняем селекты моделей
            const responseSelect = document.getElementById('responseModel');
            const embeddingSelect = document.getElementById('embeddingModel');
            
            // Очищаем существующие опции Ollama
            Array.from(responseSelect.options).forEach(option => {
                if (option.value.startsWith('ollama:')) {
                    option.remove();
                }
            });
            Array.from(embeddingSelect.options).forEach(option => {
                if (option.value.startsWith('ollama:')) {
                    option.remove();
                }
            });

            models.forEach(model => {
                // Добавляем в список моделей
                const modelDiv = document.createElement('div');
                modelDiv.className = 'flex items-center justify-between p-3 border border-gray-200 rounded-lg';
                modelDiv.innerHTML = `
                    <div>
                        <div class="font-medium">${model.name}</div>
                        <div class="text-sm text-gray-500">${model.size || 'Размер неизвестен'}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectModel('ollama:${model.name}', 'response')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            Для ответов
                        </button>
                        <button onclick="selectModel('ollama:${model.name}', 'embedding')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                            Для эмбеддингов
                        </button>
                    </div>
                `;
                container.appendChild(modelDiv);

                // Добавляем в селекты
                const responseOption = document.createElement('option');
                responseOption.value = `ollama:${model.name}`;
                responseOption.textContent = `Ollama: ${model.name}`;
                responseSelect.appendChild(responseOption);

                const embeddingOption = document.createElement('option');
                embeddingOption.value = `ollama:${model.name}`;
                embeddingOption.textContent = `Ollama: ${model.name}`;
                embeddingSelect.appendChild(embeddingOption);
            });
        }

        function selectModel(modelName, type) {
            if (type === 'response') {
                document.getElementById('responseModel').value = modelName;
            } else {
                document.getElementById('embeddingModel').value = modelName;
            }
        }

        async function saveModelSettings() {
            const responseModel = document.getElementById('responseModel').value;
            const embeddingModel = document.getElementById('embeddingModel').value;
            const apiService = document.getElementById('apiService').value;
            const apiKey = document.getElementById('apiKey').value;

            try {
                const settings = {
                    response_model: responseModel,
                    embedding_model: embeddingModel,
                    api_service: apiService,
                    api_key: apiKey
                };

                const res = await fetch(API_BASE + '/api/ai/settings/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeader()
                    },
                    body: JSON.stringify(settings)
                });

                if (res.ok) {
                    const data = await res.json();
                    alert('Настройки AI сохранены успешно!');
                    
                    // Обновляем отображение текущих настроек
                    updateCurrentSettingsDisplay(data.settings);
                    
                    // Сохраняем в localStorage для быстрого доступа
                    localStorage.setItem('aiModelSettings', JSON.stringify({
                        responseModel: responseModel,
                        embeddingModel: embeddingModel,
                        apiService: apiService,
                        apiKey: apiKey
                    }));
                } else {
                    const error = await res.json();
                    alert(`Ошибка сохранения настроек: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка сохранения настроек:', e);
                alert('Ошибка сохранения настроек');
            }
        }

        function updateConnectionStatus(type, status) {
            const indicator = document.getElementById(`${type}StatusIndicator`);
            const text = document.getElementById(`${type}StatusText`);
            
            const statusMap = {
                'saved': { color: 'bg-yellow-400', text: 'Сохранен' },
                'testing': { color: 'bg-yellow-400', text: 'Тестирование...' },
                'connected': { color: 'bg-green-400', text: 'Подключен' },
                'error': { color: 'bg-red-400', text: 'Ошибка' }
            };

            if (indicator && text && statusMap[status]) {
                indicator.className = `w-3 h-3 ${statusMap[status].color} rounded-full`;
                text.textContent = `${type.toUpperCase()}: ${statusMap[status].text}`;
            }
        }

        function checkConnectionStatus() {
            // Проверяем статус подключений при загрузке
            const savedKeys = localStorage.getItem('aiApiKeys');
            if (savedKeys) {
                updateConnectionStatus('api', 'saved');
            }
            
            // Проверяем Ollama
            loadOllamaModels();
        }

        // Новые функции для работы с настройками AI
        async function loadCurrentSettings() {
            try {
                const res = await fetch(API_BASE + '/api/ai/settings', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings;
                    
                    // Обновляем отображение текущих настроек
                    updateCurrentSettingsDisplay(settings);
                    
                    // Заполняем формы
                    if (settings.response_model) {
                        document.getElementById('responseModel').value = settings.response_model;
                    }
                    if (settings.embedding_model) {
                        document.getElementById('embeddingModel').value = settings.embedding_model;
                    }
                    if (settings.api_service) {
                        document.getElementById('apiService').value = settings.api_service;
                    }
                    if (settings.api_key) {
                        document.getElementById('apiKey').value = settings.api_key;
                    }
                }
            } catch (e) {
                console.error('Ошибка загрузки настроек:', e);
            }
        }

        function updateCurrentSettingsDisplay(settings) {
            const responseModelEl = document.getElementById('currentResponseModel');
            const embeddingModelEl = document.getElementById('currentEmbeddingModel');
            const apiServiceEl = document.getElementById('currentApiService');

            if (responseModelEl) {
                responseModelEl.textContent = settings.response_model || 'Не выбрана';
            }
            if (embeddingModelEl) {
                embeddingModelEl.textContent = settings.embedding_model || 'Не выбрана';
            }
            if (apiServiceEl) {
                apiServiceEl.textContent = settings.api_service || 'Не настроен';
            }
        }

        async function testModel(type) {
            const modelSelect = type === 'response' ? 'responseModel' : 'embeddingModel';
            const modelName = document.getElementById(modelSelect).value;

            if (!modelName) {
                alert('Выберите модель для тестирования');
                return;
            }

            try {
                const res = await fetch(API_BASE + `/api/ai/test-model?model_name=${encodeURIComponent(modelName)}&model_type=${type}`, {
                    method: 'POST',
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    alert(`✅ Модель ${modelName} работает корректно!\n\nТип: ${data.details.type}\nСтатус: ${data.details.status}`);
                } else {
                    const error = await res.json();
                    alert(`❌ Ошибка тестирования модели: ${error.detail}`);
                }
            } catch (e) {
                console.error('Ошибка тестирования модели:', e);
                alert('Ошибка тестирования модели');
            }
        }

        async function checkOllamaStatus() {
            try {
                updateConnectionStatus('ollama', 'testing');
                
                const res = await fetch(API_BASE + '/api/ai/ollama/status', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    updateConnectionStatus('ollama', 'connected');
                    alert(`✅ Ollama подключен!\n\nСтатус: ${data.status}`);
                } else {
                    updateConnectionStatus('ollama', 'error');
                    alert('❌ Ollama недоступен');
                }
            } catch (e) {
                updateConnectionStatus('ollama', 'error');
                alert('❌ Ошибка подключения к Ollama');
            }
        }

        // Функция для загрузки и отображения текущей модели
        async function loadCurrentModel() {
            try {
                const res = await fetch(API_BASE + '/api/ai/settings', {
                    headers: { ...authHeader() }
                });

                if (res.ok) {
                    const data = await res.json();
                    const settings = data.settings;
                    updateCurrentModelDisplay(settings);
                }
            } catch (e) {
                console.error('Ошибка загрузки текущей модели:', e);
            }
        }

        function updateCurrentModelDisplay(settings) {
            const displayEl = document.getElementById('currentModelDisplay');
            const nameEl = document.getElementById('currentModelName');
            
            if (!displayEl || !nameEl) return;

            const responseModel = settings.response_model || '';
            
            if (!responseModel) {
                // Используем модель по умолчанию
                nameEl.textContent = 'Mistral (по умолчанию)';
                nameEl.className = 'px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800';
                displayEl.classList.remove('hidden');
                return;
            }

            let modelName = '';
            let colorClass = 'bg-gray-100 text-gray-800';

            if (responseModel.startsWith('ollama:')) {
                modelName = `Ollama: ${responseModel.replace('ollama:', '')}`;
                colorClass = 'bg-orange-100 text-orange-800';
            } else if (responseModel.startsWith('mistral:')) {
                modelName = `Mistral: ${responseModel.replace('mistral:', '')}`;
                colorClass = 'bg-blue-100 text-blue-800';
            } else if (responseModel.startsWith('openai:')) {
                modelName = `OpenAI: ${responseModel.replace('openai:', '')}`;
                colorClass = 'bg-green-100 text-green-800';
            } else if (responseModel.startsWith('anthropic:')) {
                modelName = `Anthropic: ${responseModel.replace('anthropic:', '')}`;
                colorClass = 'bg-purple-100 text-purple-800';
            } else {
                modelName = responseModel;
            }

            nameEl.textContent = modelName;
            nameEl.className = `px-2 py-1 rounded-full text-xs font-medium ${colorClass}`;
            displayEl.classList.remove('hidden');
        }

        // Автоматическая аутентификация для демо
        autoLogin();
        
        // Проверяем токен при загрузке страницы
        if (window.localStorage.getItem('token')) {
            loadCurrentUser();
            loadCurrentModel();
        }
        // Делегирование клика по мини-бару источников, чтобы не терять обработчики
        (function(){
            const chat = document.getElementById('chatArea');
            if (!chat) return;
            chat.addEventListener('click', function(e){
                const target = e.target.closest('[id^="refbar-"]');
                if (target) {
                    e.preventDefault();
                    e.stopPropagation();
                    showSourcesUI();
                }
            });
            chat.addEventListener('keydown', function(e){
                const target = e.target.closest('[id^="refbar-"]');
                if (target && (e.key === 'Enter' || e.key === ' ')) {
                    e.preventDefault();
                    e.stopPropagation();
                    showSourcesUI();
                }
            });
        })();
        
        // Восстанавливаем мини-бар источников после полной инициализации
        setTimeout(() => {
            restoreSourcesBar();
        }, 1000);
    </script>
</body>
</html>
